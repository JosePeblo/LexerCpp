<html><head><link rel="stylesheet" href="style.css"><head><body>
<pre>
<pre><span class='k'>using</span> System;
<pre><span class='k'>using</span> System.Collections.Generic;
<pre><span class='k'>using</span> OpenTK.Compute.OpenCL;
<pre><span class='k'>using</span> OpenTK.Mathematics;
<pre>
<pre><span class='k'>namespace</span> Gepe3D
<pre><span class='d'>{</span>
<pre>    <span class='k'>public</span> <span class='k'>class</span> ParticleSystem
<pre>    <span class='d'>{</span>   
<pre>        <span class='c'>// Render</span>
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> quad_VAO;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> quad_VBO;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> instancePositions_VBO;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> instanceColours_VBO;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> Shader particleShader;
<pre>        
<pre>        <span class='c'>// Update</span>
<pre>        CLCommandQueue queue;
<pre>        CLEvent @event <span class='o'>=</span> <span class='k'>new</span> CLEvent<span class='d'>(</span><span class='d'>)</span>;
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>readonly</span> <span class='k'>int</span> ParticleCount;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> cellCount;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span> posData;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span> ePosData;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span> velData;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span> colourData;
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> <span class='k'>int</span> <span class='d'>[</span><span class='d'>]</span>   phaseData;
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>static</span> Vector3 GRAVITY          <span class='o'>=</span> <span class='k'>new</span> Vector3<span class='d'>(</span><span class='n'><span class='o'>-</span>3</span>, <span class='n'><span class='o'>-</span>6</span>,<span class='n'> 0</span><span class='d'>)</span>;
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>float</span>   PARTICLE_RADIUS  <span class='o'>=</span><span class='n'> 0.2f</span>;
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>float</span>   GRID_CELL_WIDTH  <span class='o'>=</span><span class='n'> 0.6f</span>;
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>float</span>   KERNEL_SIZE      <span class='o'>=</span><span class='n'> 0.6f</span>;
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>float</span>   REST_DENSITY     <span class='o'>=</span><span class='n'> 80f</span>;
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>int</span>
<pre>            GridRowsX <span class='o'>=</span><span class='n'> 16</span>,
<pre>            GridRowsY <span class='o'>=</span><span class='n'> 10</span>,
<pre>            GridRowsZ <span class='o'>=</span><span class='n'> 12</span>;
<pre>            
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>float</span>
<pre>            MAX_X <span class='o'>=</span> GRID_CELL_WIDTH <span class='o'>*</span> GridRowsX,
<pre>            MAX_Y <span class='o'>=</span> GRID_CELL_WIDTH <span class='o'>*</span> GridRowsY,
<pre>            MAX_Z <span class='o'>=</span> GRID_CELL_WIDTH <span class='o'>*</span> GridRowsZ;
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>static</span> <span class='k'>int</span>
<pre>            PHASE_LIQUID <span class='o'>=</span><span class='n'> 0</span>,
<pre>            PHASE_SOLID <span class='o'>=</span><span class='n'> 1</span>,
<pre>            PHASE_STATIC <span class='o'>=</span><span class='n'> 2</span>;
<pre>        
<pre>        
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> CLKernel
<pre>            k_PredictPos,
<pre>            k_CalcLambdas,
<pre>            k_FluidCorrect,
<pre>            k_CorrectPredictions,
<pre>            k_UpdateVel,
<pre>            k_CalcVorticity,
<pre>            k_ApplyVortVisc,
<pre>            k_CorrectVel,
<pre>            k_AssignParticleCells,
<pre>            k_FindCellsStartAndEnd,
<pre>            k_SortParticleIDsByCell,
<pre>            k_SolidCorrect;
<pre>        
<pre>        <span class='k'>private</span> <span class='k'>readonly</span> CLBuffer
<pre>            b_Pos,              <span class='c'>// positions</span>
<pre>            b_Vel,              <span class='c'>// velocities</span>
<pre>            b_ePos,             <span class='c'>// estimated positions</span>
<pre>            b_imass,            <span class='c'>// inverse masses</span>
<pre>            b_lambdas,          <span class='c'>// fluid correction scalar</span>
<pre>            b_phase,            <span class='c'>// particle phase</span>
<pre>            b_Vorticities,      <span class='c'>// fluid vorticities</span>
<pre>            b_PosCorrection,    <span class='c'>// position correction</span>
<pre>            b_VelCorrection,    <span class='c'>// velocity correction</span>
<pre>            
<pre>            <span class='c'>// buffers neighbour search</span>
<pre>            b_sortedParticleIDs,
<pre>            b_cellStartAndEndIDs,
<pre>            b_cellIDsOfParticles,
<pre>            b_numParticlesPerCell,
<pre>            b_particleIDinCell;
<pre>        
<pre>        
<pre>        <span class='k'>private</span> <span class='k'>bool</span>
<pre>            posDirty <span class='o'>=</span> false,
<pre>            velDirty <span class='o'>=</span> false,
<pre>            phaseDirty <span class='o'>=</span> false,
<pre>            colourDirty <span class='o'>=</span> false;
<pre>    
<pre>        List<span class='o'><</span><span class='d'>(</span><span class='k'>int</span>, <span class='k'>int</span>, <span class='k'>float</span><span class='d'>)</span><span class='o'>></span> distanceConstraints <span class='o'>=</span> <span class='k'>new</span> List<span class='o'><</span><span class='d'>(</span><span class='k'>int</span>, <span class='k'>int</span>, <span class='k'>float</span><span class='d'>)</span><span class='o'>></span><span class='d'>(</span><span class='d'>)</span>;
<pre>        
<pre>        
<pre>        
<pre>        <span class='k'>public</span> ParticleSystem<span class='d'>(</span><span class='k'>int</span> particleCount<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>this</span>.ParticleCount <span class='o'>=</span> particleCount;
<pre>            <span class='k'>this</span>.cellCount <span class='o'>=</span> GridRowsX <span class='o'>*</span> GridRowsY <span class='o'>*</span> GridRowsZ;
<pre>            posData    <span class='o'>=</span> <span class='k'>new</span> <span class='k'>float</span><span class='d'>[</span>particleCount <span class='o'>*</span><span class='n'> 3</span><span class='d'>]</span>;
<pre>            velData    <span class='o'>=</span> <span class='k'>new</span> <span class='k'>float</span><span class='d'>[</span>particleCount <span class='o'>*</span><span class='n'> 3</span><span class='d'>]</span>;
<pre>            colourData <span class='o'>=</span> <span class='k'>new</span> <span class='k'>float</span><span class='d'>[</span>particleCount <span class='o'>*</span><span class='n'> 3</span><span class='d'>]</span>;
<pre>            ePosData   <span class='o'>=</span> <span class='k'>new</span> <span class='k'>float</span><span class='d'>[</span>particleCount <span class='o'>*</span><span class='n'> 3</span><span class='d'>]</span>;
<pre>            phaseData  <span class='o'>=</span> <span class='k'>new</span> <span class='k'>int</span>  <span class='d'>[</span>particleCount<span class='d'>]</span>;
<pre>            
<pre>            
<pre>            <span class='c'>///////////////////</span>
<pre>            <span class='c'>// Set up OpenCL //</span>
<pre>            <span class='c'>///////////////////</span>
<pre>            
<pre>            <span class='c'>// set up context <span class='o'>&</span> queue</span>
<pre>            CLResultCode result;
<pre>            CLPlatform<span class='d'>[</span><span class='d'>]</span> platforms;
<pre>            CLDevice<span class='d'>[</span><span class='d'>]</span> devices;
<pre>            result <span class='o'>=</span> CL.GetPlatformIds<span class='d'>(</span><span class='k'>out</span> platforms<span class='d'>)</span>;
<pre>            result <span class='o'>=</span> CL.GetDeviceIds<span class='d'>(</span>platforms<span class='n'><span class='d'>[</span>0</span><span class='d'>]</span>, DeviceType.Gpu, <span class='k'>out</span> devices<span class='d'>)</span>;
<pre>            <span class='k'>if</span> <span class='d'>(</span>result <span class='o'>==</span> CLResultCode.DeviceNotFound<span class='d'>)</span> <span class='d'>{</span>
<pre>                CL.GetDeviceIds<span class='d'>(</span>platforms<span class='n'><span class='d'>[</span>0</span><span class='d'>]</span>, DeviceType.All, <span class='k'>out</span> devices<span class='d'>)</span>;
<pre>                System.Console.WriteLine<span class='d'>(</span><span class='s'>"Failed to initiate OpenCL GPU, cannot use hardware acceleration"</span><span class='d'>)</span>;
<pre>            <span class='d'>}</span>
<pre>            CLContext context <span class='o'>=</span> CL.CreateContext<span class='d'>(</span><span class='k'>new</span> IntPtr<span class='d'>(</span><span class='d'>)</span>,<span class='n'> 1</span>, devices, <span class='k'>new</span> IntPtr<span class='d'>(</span><span class='d'>)</span>, <span class='k'>new</span> IntPtr<span class='d'>(</span><span class='d'>)</span>, <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.queue <span class='o'>=</span> CL.CreateCommandQueueWithProperties<span class='d'>(</span>context, devices<span class='n'><span class='d'>[</span>0</span><span class='d'>]</span>, <span class='k'>new</span> IntPtr<span class='d'>(</span><span class='d'>)</span>, <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            
<pre>            <span class='c'>// load kernels</span>
<pre>            <span class='k'>string</span> varDefines            <span class='o'>=</span> GenerateDefines<span class='d'>(</span><span class='d'>)</span>; <span class='c'>// combine with other source strings to add common functions</span>
<pre>            CLProgram pbdProgram         <span class='o'>=</span> CLUtils.BuildClProgram<span class='d'>(</span>context, devices, varDefines <span class='o'>+</span> commonFuncSource <span class='o'>+</span> pbdCommonSource   <span class='d'>)</span>;
<pre>            CLProgram fluidProgram       <span class='o'>=</span> CLUtils.BuildClProgram<span class='d'>(</span>context, devices, varDefines <span class='o'>+</span> commonFuncSource <span class='o'>+</span> fluidProjectSource<span class='d'>)</span>;
<pre>            CLProgram solidProgram       <span class='o'>=</span> CLUtils.BuildClProgram<span class='d'>(</span>context, devices, varDefines <span class='o'>+</span> commonFuncSource <span class='o'>+</span> solidProjectSource<span class='d'>)</span>;
<pre>            
<pre>            <span class='k'>this</span>.k_AssignParticleCells    <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"assign_particle_cells"</span>      , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_FindCellsStartAndEnd   <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"find_cells_start_and_end"</span>   , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_SortParticleIDsByCell  <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"sort_particle_ids_by_cell"</span>  , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_PredictPos             <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"predict_positions"</span>          , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_CorrectPredictions     <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"correct_predictions"</span>        , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_UpdateVel              <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> pbdProgram   , <span class='s'>"update_velocity"</span>            , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_CalcLambdas            <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> fluidProgram , <span class='s'>"calculate_lambdas"</span>          , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_FluidCorrect           <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> fluidProgram , <span class='s'>"calc_fluid_corrections"</span>     , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_CalcVorticity          <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> fluidProgram , <span class='s'>"calculate_vorticities"</span>      , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_ApplyVortVisc          <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> fluidProgram , <span class='s'>"apply_vorticity_viscosity"</span>  , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_CorrectVel             <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> fluidProgram , <span class='s'>"correct_fluid_vel"</span>          , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            <span class='k'>this</span>.k_SolidCorrect           <span class='o'>=</span> CL.CreateKernel<span class='d'>(</span> solidProgram , <span class='s'>"calc_solid_corrections"</span>     , <span class='k'>out</span> result<span class='d'>)</span>;
<pre>            
<pre>            <span class='c'>// create buffers</span>
<pre>            <span class='k'>this</span>.b_Pos                 <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_Vel                 <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_ePos                <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_imass               <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 1</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_lambdas             <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_PosCorrection       <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_Vorticities         <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_VelCorrection       <span class='o'>=</span> CLUtils.EnqueueMakeFloatBuffer<span class='d'>(</span>context, queue,  particleCount <span class='o'>*</span><span class='n'> 3</span>  ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_phase               <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_sortedParticleIDs   <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_cellIDsOfParticles  <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_particleIDinCell    <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  particleCount      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_cellStartAndEndIDs  <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  cellCount <span class='o'>*</span><span class='n'> 2</span>      ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            <span class='k'>this</span>.b_numParticlesPerCell <span class='o'>=</span> CLUtils.EnqueueMakeIntBuffer  <span class='d'>(</span>context, queue,  cellCount          ,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            
<pre>            <span class='c'>// ensure fills are completed</span>
<pre>            CL.Flush<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            CL.Finish<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            
<pre>            
<pre>            <span class='c'>/////////////////////////////////</span>
<pre>            <span class='c'>// Set up OpenGL <span class='k'>for</span> rendering //</span>
<pre>            <span class='c'>/////////////////////////////////</span>
<pre>            
<pre>            <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span> vertexData <span class='o'>=</span> <span class='k'>new</span> <span class='k'>float</span> <span class='d'>[</span><span class='d'>]</span>
<pre>            <span class='d'>{</span>
<pre>                <span class='c'>//  X value                    Y value          Z value</span>
<pre>                <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,
<pre>                 PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,  <span class='c'>// triangle<span class='n'> 1</span></span>
<pre>                 PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,     PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,
<pre>                
<pre>                <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,
<pre>                 PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,     PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,  <span class='c'>// triangle<span class='n'> 2</span></span>
<pre>                <span class='o'>-</span>PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,     PARTICLE_RADIUS<span class='o'> /\\$<span class='n'> 2</span>,    <span class='n'> 0</span>,
<pre>            <span class='d'>}</span>;
<pre>            
<pre>            quad_VAO              <span class='o'>=</span> GLUtils.GenVAO<span class='d'>(</span><span class='d'>)</span>;
<pre>            quad_VBO              <span class='o'>=</span> GLUtils.GenVBO<span class='d'>(</span>vertexData<span class='d'>)</span>;
<pre>            instancePositions_VBO <span class='o'>=</span> GLUtils.GenVBO<span class='d'>(</span> posData <span class='d'>)</span>;
<pre>            instanceColours_VBO   <span class='o'>=</span> GLUtils.GenVBO<span class='d'>(</span> colourData <span class='d'>)</span>;
<pre>            GLUtils.VaoFloatAttrib        <span class='d'>(</span>quad_VAO, quad_VBO             ,<span class='n'> 0</span>,<span class='n'> 3</span>,<span class='n'> 3</span>,<span class='n'> 0</span><span class='d'>)</span>; <span class='c'>// vertex positions</span>
<pre>            GLUtils.VaoInstanceFloatAttrib<span class='d'>(</span>quad_VAO, instancePositions_VBO,<span class='n'> 1</span>,<span class='n'> 3</span>,<span class='n'> 3</span>,<span class='n'> 0</span><span class='d'>)</span>;
<pre>            GLUtils.VaoInstanceFloatAttrib<span class='d'>(</span>quad_VAO, instanceColours_VBO  ,<span class='n'> 2</span>,<span class='n'> 3</span>,<span class='n'> 3</span>,<span class='n'> 0</span><span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='c'>// set pos, phase, colour, constraints, </span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> SetPos<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>float</span> x, <span class='k'>float</span> y, <span class='k'>float</span> z<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>=</span> x;
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>=</span> y;
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>=</span> z;
<pre>            posDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> AddPos<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>float</span> x, <span class='k'>float</span> y, <span class='k'>float</span> z<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>+=</span> x;
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>+=</span> y;
<pre>            posData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>+=</span> z;
<pre>            posDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> Vector3 GetPos<span class='d'>(</span><span class='k'>int</span> id<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>return</span> <span class='k'>new</span> Vector3<span class='d'>(</span> posData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span>, posData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span>, posData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> SetVel<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>float</span> x, <span class='k'>float</span> y, <span class='k'>float</span> z<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>=</span> x;
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>=</span> y;
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>=</span> z;
<pre>            velDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> AddVel<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>float</span> x, <span class='k'>float</span> y, <span class='k'>float</span> z<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>+=</span> x;
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>+=</span> y;
<pre>            velData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>+=</span> z;
<pre>            velDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> Vector3 GetVel<span class='d'>(</span><span class='k'>int</span> id<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>return</span> <span class='k'>new</span> Vector3<span class='d'>(</span> velData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span>, velData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span>, velData<span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> SetPhase<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>int</span> phase<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            phaseData <span class='d'>[</span>id<span class='d'>]</span> <span class='o'>=</span> phase;
<pre>            phaseDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> SetColour<span class='d'>(</span><span class='k'>int</span> id, <span class='k'>float</span> r, <span class='k'>float</span> g, <span class='k'>float</span> b<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            colourData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>=</span> r;
<pre>            colourData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>=</span> g;
<pre>            colourData <span class='d'>[</span>id <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>=</span> b;
<pre>            colourDirty <span class='o'>=</span> true;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> AddDistConstra<span class='k'>int</span><span class='d'>(</span><span class='k'>int</span> id1, <span class='k'>int</span> id2, <span class='k'>float</span> dist<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            distanceConstraints.Add<span class='d'>(</span> <span class='d'>(</span>id1, id2, dist<span class='d'>)</span> <span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        
<pre>        <span class='k'>private</span> <span class='k'>string</span> GenerateDefines<span class='d'>(</span><span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>string</span> defines <span class='o'>=</span> <span class='s'>""</span>;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define CELLCOUNT_X "</span> <span class='o'>+</span> GridRowsX;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define CELLCOUNT_Y "</span> <span class='o'>+</span> GridRowsY;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define CELLCOUNT_Z "</span> <span class='o'>+</span> GridRowsZ;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define CELL_WIDTH "</span> <span class='o'>+</span> GRID_CELL_WIDTH.ToString<span class='d'>(</span><span class='s'><span class='n'>"0.0000</span>"</span><span class='d'>)</span> <span class='o'>+</span> <span class='s'>"f"</span>;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define KERNEL_SIZE "</span> <span class='o'>+</span> KERNEL_SIZE.ToString<span class='d'>(</span><span class='s'><span class='n'>"0.0000</span>"</span><span class='d'>)</span> <span class='o'>+</span> <span class='s'>"f"</span>;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define REST_DENSITY "</span> <span class='o'>+</span> REST_DENSITY.ToString<span class='d'>(</span><span class='s'><span class='n'>"0.0000</span>"</span><span class='d'>)</span> <span class='o'>+</span> <span class='s'>"f"</span>;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define PHASE_LIQUID "</span> <span class='o'>+</span> PHASE_LIQUID;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define PHASE_SOLID "</span> <span class='o'>+</span> PHASE_SOLID;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span> <span class='o'>+</span> <span class='s'>"#define PHASE_STATIC "</span> <span class='o'>+</span> PHASE_STATIC;
<pre>            defines <span class='o'>+=</span> <span class='s'>"\n"</span>;
<pre>            
<pre>            <span class='k'>return</span> defines;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> Render<span class='d'>(</span>MainWindow world<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>if</span> <span class='d'>(</span>colourDirty<span class='d'>)</span> <span class='d'>{</span>
<pre>                GLUtils.ReplaceBufferData<span class='d'>(</span>instanceColours_VBO, colourData <span class='d'>)</span>;
<pre>                colourDirty <span class='o'>=</span> false;
<pre>            <span class='d'>}</span>
<pre>            GLUtils.ReplaceBufferData<span class='d'>(</span>instancePositions_VBO, posData <span class='d'>)</span>;
<pre>            
<pre>            particleShader.Use<span class='d'>(</span><span class='d'>)</span>;
<pre>            particleShader.SetVector3<span class='d'>(</span><span class='s'>"lightPos"</span>, world.lightPos<span class='d'>)</span>;
<pre>            particleShader.SetMatrix4<span class='d'>(</span><span class='s'>"viewMatrix"</span>, world.character.activeCam.GetViewMatrix<span class='d'>(</span><span class='d'>)</span><span class='d'>)</span>;
<pre>            particleShader.SetMatrix4<span class='d'>(</span><span class='s'>"projectionMatrix"</span>, world.character.activeCam.GetProjectionMatrix<span class='d'>(</span><span class='d'>)</span><span class='d'>)</span>;
<pre>            particleShader.SetFloat<span class='d'>(</span><span class='s'>"particleRadius"</span>, PARTICLE_RADIUS<span class='d'>)</span>;
<pre>            particleShader.SetFloat<span class='d'>(</span><span class='s'>"maxX"</span>, MAX_X<span class='d'>)</span>;
<pre>            
<pre>            GLUtils.DrawInstancedVAO<span class='d'>(</span>quad_VAO,<span class='n'> 6</span>, ParticleCount<span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>        
<pre>        
<pre>        <span class='k'>public</span> <span class='k'>void</span> Update<span class='d'>(</span><span class='k'>float</span> delta, <span class='k'>float</span> shiftX<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            <span class='k'>if</span> <span class='d'>(</span>posDirty<span class='d'>)</span> <span class='d'>{</span>
<pre>                CL.EnqueueWriteBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_Pos, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, posData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>                posDirty <span class='o'>=</span> false;
<pre>            <span class='d'>}</span>
<pre>            
<pre>            <span class='k'>if</span> <span class='d'>(</span>velDirty<span class='d'>)</span> <span class='d'>{</span>
<pre>                CL.EnqueueWriteBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_Vel, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, velData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>                velDirty <span class='o'>=</span> false;
<pre>            <span class='d'>}</span>
<pre>            
<pre>            <span class='k'>if</span> <span class='d'>(</span>phaseDirty<span class='d'>)</span> <span class='d'>{</span>
<pre>                CL.EnqueueWriteBuffer<span class='o'><</span><span class='k'>int</span><span class='o'>></span><span class='d'>(</span>queue, b_phase, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, phaseData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>                phaseDirty <span class='o'>=</span> false;
<pre>            <span class='d'>}</span>
<pre>            
<pre>            CLUtils.EnqueueFillIntBuffer<span class='d'>(</span>queue, b_sortedParticleIDs,<span class='n'> 0</span>, ParticleCount<span class='d'>)</span>;
<pre>            CLUtils.EnqueueFillIntBuffer<span class='d'>(</span>queue, b_numParticlesPerCell,<span class='n'> 0</span>, cellCount<span class='d'>)</span>;
<pre>            CLUtils.EnqueueFillFloatBuffer<span class='d'>(</span>queue, b_PosCorrection,<span class='n'> 0</span>, ParticleCount <span class='o'>*</span><span class='n'> 3</span><span class='d'>)</span>;
<pre>            
<pre>
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_PredictPos             , ParticleCount  , delta, b_Pos, b_Vel, b_ePos, b_phase, GRAVITY.X, GRAVITY.Y, GRAVITY.Z<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_AssignParticleCells     , ParticleCount  , b_ePos, b_numParticlesPerCell, b_cellIDsOfParticles, b_particleIDinCell<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_FindCellsStartAndEnd   , cellCount      , b_numParticlesPerCell, b_cellStartAndEndIDs<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_SortParticleIDsByCell  , ParticleCount  , b_particleIDinCell, b_cellStartAndEndIDs, b_cellIDsOfParticles, b_sortedParticleIDs<span class='d'>)</span>;
<pre>            
<pre>            <span class='c'>// correct the predicted positions to satisfy fluid and contact constraints</span>
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_CalcLambdas            , ParticleCount  , b_ePos, b_imass, b_lambdas, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_FluidCorrect           , ParticleCount  , b_ePos, b_imass, b_lambdas, b_PosCorrection, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_SolidCorrect           , ParticleCount  , b_ePos, b_imass, b_PosCorrection, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_CorrectPredictions     , ParticleCount  , b_Pos, b_ePos, b_PosCorrection, b_phase<span class='d'>)</span>;
<pre>            
<pre>            CpuSolveDistConstraints<span class='n'><span class='d'>(</span>0.2f</span>,<span class='n'> 2</span><span class='d'>)</span>; <span class='c'>// parameters<span class='o'>:</span> stiffness, iterations</span>
<pre>            
<pre>    
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_UpdateVel              , ParticleCount  , delta, b_Pos, b_Vel, b_ePos, b_phase, shiftX<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_CalcVorticity          , ParticleCount  , b_Pos, b_Vel, b_Vorticities, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_ApplyVortVisc          , ParticleCount  , b_Pos, b_Vel, b_Vorticities, b_VelCorrection, b_imass, delta, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span class='d'>)</span>;
<pre>            CLUtils.EnqueueKernel<span class='d'>(</span>queue, k_CorrectVel             , ParticleCount  , b_Vel, b_VelCorrection<span class='d'>)</span>;
<pre>            
<pre>    
<pre>            CL.EnqueueReadBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_Pos, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, posData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>            CL.EnqueueReadBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_Vel, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, velData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>            
<pre>            CL.Flush<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            CL.Finish<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            
<pre>        <span class='d'>}</span>
<pre>        
<pre>
<pre>        <span class='k'>private</span> <span class='k'>void</span> CpuSolveDistConstraints<span class='d'>(</span><span class='k'>float</span> stiffness, <span class='k'>int</span> iterations<span class='d'>)</span>
<pre>        <span class='d'>{</span>
<pre>            stiffness <span class='o'>=</span><span class='n'> 1</span> <span class='o'>-</span> MathF.Pow<span class='d'>(</span><span class='n'> 1</span> <span class='o'>-</span> stiffness,<span class='n'> 1f</span><span class='o'> / </span><span class='d'>(</span><span class='k'>float</span><span class='d'>)</span> iterations <span class='d'>)</span>;
<pre>            
<pre>            <span class='c'>// read estimated positions from the GPU</span>
<pre>            CL.EnqueueReadBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_ePos, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, ePosData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>            CL.Flush<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            CL.Finish<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            
<pre>            <span class='k'>for</span> <span class='d'>(</span><span class='k'>int</span> i <span class='o'>=</span><span class='n'> 0</span>; i <span class='o'><</span> iterations; i<span class='o'>++</span><span class='d'>)</span>
<pre>            <span class='d'>{</span>
<pre>                <span class='k'>foreach</span><span class='d'>(</span> <span class='d'>(</span><span class='k'>int</span>, <span class='k'>int</span>, <span class='k'>float</span><span class='d'>)</span> constra<span class='k'>int</span> in distanceConstraints <span class='d'>)</span>
<pre>                <span class='d'>{</span>
<pre>                    <span class='k'>int</span> p1 <span class='o'>=</span> constra<span class='k'>int</span>.Item1;
<pre>                    <span class='k'>int</span> p2 <span class='o'>=</span> constra<span class='k'>int</span>.Item2;
<pre>                    <span class='k'>float</span> restDist <span class='o'>=</span> constra<span class='k'>int</span>.Item3;
<pre>                    <span class='k'>float</span> imass1 <span class='o'>=</span><span class='n'> 1</span>;
<pre>                    <span class='k'>float</span> imass2 <span class='o'>=</span><span class='n'> 1</span>;
<pre>                    <span class='k'>if</span> <span class='d'>(</span>imass1 <span class='o'>==</span><span class='n'> 0</span> <span class='o'>&&</span> imass2 <span class='o'>==</span><span class='n'> 0</span><span class='d'>)</span> <span class='k'>return</span>;
<pre>
<pre>                    Vector3 epos1 <span class='o'>=</span> <span class='k'>new</span> Vector3<span class='d'>(</span>ePosData <span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span>, ePosData <span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span>, ePosData <span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span><span class='d'>)</span>;
<pre>                    Vector3 epos2 <span class='o'>=</span> <span class='k'>new</span> Vector3<span class='d'>(</span>ePosData <span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span>, ePosData <span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span>, ePosData <span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span><span class='d'>)</span>;
<pre>
<pre>                    Vector3 dir <span class='o'>=</span> epos1 <span class='o'>-</span> epos2;
<pre>                    <span class='k'>float</span> displacement <span class='o'>=</span> dir.Length <span class='o'>-</span> restDist;
<pre>                    dir.Normalize<span class='d'>(</span><span class='d'>)</span>;
<pre>
<pre>                    <span class='k'>float</span> w1 <span class='o'>=</span> imass1<span class='o'> / </span><span class='d'>(</span>imass1 <span class='o'>+</span> imass2<span class='d'>)</span>;
<pre>                    <span class='k'>float</span> w2 <span class='o'>=</span> imass2<span class='o'> / </span><span class='d'>(</span>imass1 <span class='o'>+</span> imass2<span class='d'>)</span>;
<pre>
<pre>                    Vector3 correction1 <span class='o'>=</span> <span class='o'>-</span>w1 <span class='o'>*</span> displacement <span class='o'>*</span> dir;
<pre>                    Vector3 correction2 <span class='o'>=</span> <span class='o'>+</span>w2 <span class='o'>*</span> displacement <span class='o'>*</span> dir;
<pre>                    
<pre>                    ePosData<span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>+=</span> correction1.X <span class='o'>*</span> stiffness;
<pre>                    ePosData<span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>+=</span> correction1.Y <span class='o'>*</span> stiffness;
<pre>                    ePosData<span class='d'>[</span>p1 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>+=</span> correction1.Z <span class='o'>*</span> stiffness;
<pre>                    
<pre>                    ePosData<span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 0</span><span class='d'>]</span> <span class='o'>+=</span> correction2.X <span class='o'>*</span> stiffness;
<pre>                    ePosData<span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 1</span><span class='d'>]</span> <span class='o'>+=</span> correction2.Y <span class='o'>*</span> stiffness;
<pre>                    ePosData<span class='d'>[</span>p2 <span class='o'>*</span><span class='n'> 3</span> <span class='o'>+</span><span class='n'> 2</span><span class='d'>]</span> <span class='o'>+=</span> correction2.Z <span class='o'>*</span> stiffness;
<pre>                <span class='d'>}</span>
<pre>            <span class='d'>}</span>
<pre>            
<pre>            <span class='c'>// write estimated positions back to the GPU</span>
<pre>            CL.EnqueueWriteBuffer<span class='o'><</span><span class='k'>float</span><span class='o'>></span><span class='d'>(</span>queue, b_ePos, false, <span class='k'>new</span> UIntPtr<span class='d'>(</span><span class='d'>)</span>, ePosData, null, <span class='k'>out</span> @event<span class='d'>)</span>;
<pre>            CL.Flush<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>            CL.Finish<span class='d'>(</span>queue<span class='d'>)</span>;
<pre>        <span class='d'>}</span>
<pre>
<pre>    <span class='d'>}</span>
<pre><span class='d'>}</span>
<pre><span class='c'>// end comment</span>
</body></html>